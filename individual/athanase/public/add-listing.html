<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add Listing â€” SwapIt</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/supabase-client.js" type="module"></script>
</head>
<body>
  <div class="container" style="padding:24px">
    <h1>Create a new listing</h1>
    <form id="listingForm" style="max-width:720px">
      <label>Title<br><input id="title" required></label><br>
      <label>Description<br><textarea id="description" rows="4"></textarea></label><br>
      <label>Category<br>
        <select id="category">
          <option value="electronics">Electronics</option>
          <option value="transport">Transport</option>
          <option value="books">Books</option>
          <option value="clothing">Clothing</option>
          <option value="music">Music</option>
          <option value="home">Home</option>
        </select>
      </label><br>
      <label>Price (GHS/day)<br><input id="price" type="number" min="0"></label><br>
      <label>Location<br><input id="location"></label><br>
      <label>Image<br><input id="imageInput" type="file" accept="image/*"></label><br>
      <button class="btn btn--primary" type="submit">Create listing</button>
      <a href="dashboard.html" class="btn">Cancel</a>
    </form>
  </div>

  <script>
    document.getElementById('listingForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (typeof window.SUPABASE_READY !== 'undefined') {
        const r = await window.SUPABASE_READY;
        if (r?.error) console.warn('Supabase init error', r.error);
      }
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const category = document.getElementById('category').value;
      const price = parseFloat(document.getElementById('price').value) || 0;
      const location = document.getElementById('location').value.trim() || 'Unknown';

      // get selected file
      const f = document.getElementById('imageInput').files[0];
      let imageUrl = null;

      // If there's a file, attempt storage upload to 'public' bucket
      if (f) {
        try {
          const { data: userData } = await window.supabase.auth.getUser();
          const user = userData?.user;
          const ownerId = user?.id || 'anonymous';
          const key = `listings/${ownerId}-${Date.now()}-${f.name.replace(/[^a-zA-Z0-9_.-]/g,'')}`;

          const uploadRes = await window.supabase.storage.from('public').upload(key, f, { upsert: true });
          if (uploadRes.error) throw uploadRes.error;

          const { data: urlData } = window.supabase.storage.from('public').getPublicUrl(key);
          imageUrl = urlData?.publicUrl || null;
        } catch (uploadErr) {
          console.warn('Storage upload failed, will fallback to data URL', uploadErr?.message || uploadErr);
          // Fallback to data URL
          try {
            imageUrl = await new Promise((res, rej)=>{
              const r = new FileReader();
              r.onload = ()=>res(r.result);
              r.onerror = rej;
              r.readAsDataURL(f);
            });
          } catch (e2) {
            console.warn('data URL fallback failed', e2);
            imageUrl = null;
          }
        }
      }

      try {
        const { data: userData } = await window.supabase.auth.getUser();
        const user = userData?.user;
        if (!user) {
          alert('You must be logged in to create a listing.');
          window.location.href = 'login.html';
          return;
        }

        // Try insert into Supabase items table
        const payload = {
          title, description, category, price, location, image_url: imageUrl, owner_id: user.id
        };
        const { data, error } = await window.supabase.from('items').insert([payload]);
        if (error) throw error;
        alert('Listing created successfully.');
        window.location.href = 'browse.html';
      } catch (err) {
        console.warn('create listing error', err?.message || err);
        // Fallback: save locally so the listing appears for this user only
        const pending = JSON.parse(localStorage.getItem('swapit_pending_items')||'[]');
        pending.push({ id: 'local-'+Date.now(), title, description, category, price, location, image_url: imgData });
        localStorage.setItem('swapit_pending_items', JSON.stringify(pending));
        alert('Could not save to the server. Saved locally. You can still view it in the browse page for this browser session.');
        window.location.href = 'browse.html';
      }
    });
  </script>
</body>
</html>
